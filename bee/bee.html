<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>bee</title>
  <style>
    canvas { border: 1px solid #000; }
  </style>
    <script src="./KeyController.js"></script>
    <script src="./Entity.js"></script>
    <script src="./EnemyTank.js"></script>
    <script src="./EnemyBullet.js"></script>
    <script src="./OurTank.js"></script>
    <script src="./OurBullet.js"></script>
</head>
<body>
    <canvas id="_Canvas" width="560" height="560"></canvas>
    <img id="babyTankImg" src="./images/icons8-alien-monster-94.png" alt="Source Image" style="display:none;">
    <img id="M.shieldImg" src="./images/icons8-shield-48 2.png" alt="Source Image" style="display:none;">
    <img id="E.shieldImg" src="./images/icons8-shield-48.png" alt="Source Image" style="display:none;">
    <img id="tankImg" src="./images/icons8-tank-16.png" alt="Source Image" style="display:none;">
    <img id="M.tankImg" src="./images/icons8-tank-top-view-50 1.png" alt="Source Image" style="display:none;">
    <img id="peopleImg" src="./images/icons8-top-view-man-48 1.png" alt="Source Image" style="display:none;">
    <img id="M.bulletImg" src="./images/icons8-bullet-64.png" alt="Source Image" style="display:none;">
    <img id="E.bulletImg" src="./images/icons8-bullet-24.png" alt="Source Image" style="display:none;">
    <img id="firstaidkit" src="./images/icons8-organ-transplantation-24.png" alt="Source Image" style="display:none;">
    <img id="diode" src="./images/icons8-led-diode-48.png" alt="Source Image" style="display:none;">
    <img id="lightImg" src="./images/—Pngtree—light effect of lightning blue_6183369.png" alt="Source Image" style="display:none;">
</body>
</html>

<script>

console.log("run()");
const canvas = document.getElementById('_Canvas');
const ctx = canvas.getContext('2d');     

let countDown = 3000 ;
const CELL_SIZE = 14 ;
const TOTAL_ROWS = 40 ;
const TOTAL_COLS = 40 ;
let isRun = true ;
let lastTime = 0 ;
let tanks = [] ; 
let target = [] ;
let wave = 0 ;


function drawImg(imgId, x, y, width, height, rotation) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(( rotation * Math.PI) / 180);
        ctx.translate( -x, -y);
        let imgObj = document.getElementById( imgId) ;
        ctx.drawImage(imgObj, x-width/2, y-height/2, width, height ) ;
        ctx.restore();    
}

function drawBackground(){
    ctx.strokeStyle = "orange";
    for (let i=0;i<40+1;i++){
        ctx.moveTo(CELL_SIZE*i,0 );
        ctx.lineTo(CELL_SIZE*i,CELL_SIZE*40);
    } 
    for (let j=0;j<40+1;j++){
        ctx.moveTo(0,CELL_SIZE*j );
        ctx.lineTo(CELL_SIZE*40,CELL_SIZE*j);    
    }
    ctx.stroke();
}

function run(time) {
    if (lastTime === 0) {
        lastTime = time;
    }

    // 計算自上次更新以來經過的時間
    const deltaTime = time - lastTime
    if ( deltaTime < 50 ) {
        requestAnimationFrame(run);
        return ;
    }
    lastTime = time ;


    ctx.fillStyle = `rgb(0,0,0)` ;
    ctx.fillRect( 0 , 0 , 560 , 560 ) ;
    MyTank.process() ;
    OurBullet.process() ;
    EnemyTank.process() ;
    EnemyBullet.process() ;

    if (wave < 9 ){
        if (wave == 8){
            ctx.fillStyle = `rgb(255,0,0)` ;
            ctx.font = "20px Arial";
            ctx.fillText(" 前方高能 ",460,560);
        }else{
            ctx.fillStyle = `rgb(255,255,255)` ;
            ctx.font = "20px Arial";
            ctx.fillText(`第${wave}波`,250,20 );
        }
    }
    ctx.fillStyle = `rgb(255,255,255)` ;
    ctx.font = "20px Arial";
    ctx.fillText(`我方${MyTank.objs.length}隻`,0,550 );
    ctx.font = "20px Arial";
    ctx.fillText(`敵方${EnemyTank.objs.length}隻`, 470, 550 );

    if (MyTank.objs.length == 0){
        ctx.fillStyle = `rgb(255,0,0)` ;
        ctx.font = "80px Arial";
        ctx.fillText("GAME OVER",20,350);
    }

    if ( EnemyTank.objs.length == 0 ) {
        wave++ ;
        if (wave < 8 ) {
            for ( let i= 0;i<wave;i++ ) {
                new SuperTank() ;
            }
        } 
        if ( wave == 8 ) {
            new BigTank()  ;
        }
        if ( wave > 8 ) {
            ctx.fillStyle = `rgb(0,255,0)` ;
            ctx.font = "200px Arial";
            ctx.fillText("WIN",50,350 );
        }
    }
    //if (Math.floor(Math.random()*400) == 0){
    //    tanks [tanks.length] = new firstAidKit () ;
    //}
    requestAnimationFrame(run);
}

window.onload=function() {

    for (let i=0;i<0;i++){
        new BigTank () ;
    }
    for (let i=0;i<0;i++){
        new EnemyTank() ;
    }
    for (let i=0;i<8;i++){
        new BabyTank () ;
    }
    for (let i=0;i<0;i++){
        new ShieldPeople () ;
    }

    for (let i=0;i<2;i++){
        new MyTank(30, 20, new KeyController(i) );
    }
    for (let i=0;i<2;i++){
        new AutoMyTank(30, 20, new KeyController(i) );
    }
    requestAnimationFrame(run);
}

</script> 