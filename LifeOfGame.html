<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>演化模擬</title>
  <style>
    canvas { border: 1px solid #000; }
  </style>
</head>
<body>
  <canvas id="_Canvas" width="800" height="800"></canvas>
  <img id="frogImg" src="./frog.png" alt="Source Image" style="display:none;">
</body>
</html>

<script>
//=============================
//==========  class ===========
//=============================
class Tree {
  static GROW_UP_HEIGHT = 10 ;
  static BORN_PROBABILITY = 0.25 ;
  static INIT_HEIGHT = 50 ;
  nowHeigh = Tree.INIT_HEIGHT ; 
  limitHeight ; //亂數100~300
  lackSunLightCount = 0 ; //大於4次則死
  constructor() {
    this.limitHeight = 100 + Math.floor( Math.random()*201 );
  }

  nextRun(){
    this.nowHeigh=this.nowHeigh+Tree.GROW_UP_HEIGHT;
    if (this.nowHeigh>this.limitHeight){
      this.nowHeigh=this.limitHeight ;
    }
  }
 

}
class Deer {
  isMale ;
  heigh ;  //短100cm , 高200cm 
}

class World {
  static nextRun() {
    for (let row=0; row<WORLD_ROWS;row++) {
      for (let col=0; col<WORLD_COLS;col++) {
        if( matrix[row][col] instanceof Tree){
          matrix[row][col].nextRun();
        } 
      }
    }
    World.bornTrees();
  }

  //傳回空地周圍九宮格樹的陣列
  static getTreesAound( row, col ) {
    let trees = [] ;
    for( let j=-1; j<2; j++ ) {
      for( let i=-1; i<2; i++ ) {
        if ( matrix[row+j][col+i] instanceof Tree ) {
          if (matrix[row+j][col+i].nowHeigh!= Tree.INIT_HEIGHT ){
            trees[trees.length] =  matrix[row+j][col+i] ;
          }
        }
      }
    }
    return trees ;
  }

  static bornTrees() {
    for (let row=1; row<WORLD_ROWS-1;row++) {
      for (let col=1; col<WORLD_COLS-1;col++) {
        if( matrix[row][col] == 0 ){
          let trees = World.getTreesAound( row, col ) ;
          let random = Math.floor( 1+Math.random()*8 );  //return 1~8
          if ( random <= trees.length ) {
            //要種了
            let random2 = Math.floor( Math.random()*trees.length ); 
            matrix[row][col] = new Tree() ;
            matrix[row][col].limitHeight = trees[random2].limitHeight ;
          }
        } 
      }
    }
  }

  static drawWorld() {
    cleanScreen();
    drawCells();
    //
    for(let row=0; row<WINDOW_ROWS;row++) {
      for(let col=0; col<WINDOW_COLS;col++) {
        if( matrix[row][col] instanceof Tree){
          drawFrog(row,col) ;
        }
      }
    }
  }
}

let t = new Tree() ;
let d = new Deer() ;
console.log( t instanceof Tree ) ;
console.log( t instanceof Deer ) ;

//=============================
//==========  function ===========
//=============================

function cleanScreen() {
  ctx.fillStyle = "white" ;
  ctx.fillRect(0,0,canvas.width, canvas.height) ;
}

//畫出螢幕上的格子
function drawCells() {
  ctx.beginPath() ;
  ctx.lineWidth = 2;
  ctx.strokeStyle = "orange";

  for (let j=0; j<WINDOW_ROWS+1;j++) {
    ctx.moveTo(0,CELL_SIZE*j);
    ctx.lineTo( CELL_SIZE*WINDOW_COLS,CELL_SIZE*j);
  }
  for (let j=0; j<WINDOW_COLS+1;j++) {
    ctx.moveTo(CELL_SIZE*j,0 );
    ctx.lineTo(CELL_SIZE*j,CELL_SIZE*WINDOW_ROWS);
  }
  ctx.stroke();
}

function drawFrog(row, col) {
  let img = document.getElementById('frogImg');
  ctx.drawImage(img, col*CELL_SIZE, row*CELL_SIZE ); 

}


//檢查空地，周圍九宮格是否有樹，有的話回傳true否則回傳false
function haveTreeAound( row, col ) {
  for( let j=-1; j<2; j++ ) {
    for( let i=-1; i<2; i++ ) {
      if ( matrix[row+j][col+i] instanceof Tree ) {
        return true ;
      }
    }
  }
}

//檢查所有空地，看看是否要生出小樹
function bornTree() {
}

window.onload = function() {
  drawCells() ;
  drawFrog(5,5) ;
  drawFrog(5,45) ;
  drawFrog(45,5) ;
  drawFrog(45,45) ;
  drawFrog(25,25) ;
}

function keydownEvent(event) {
  switch(event.code) {
    case 'Space':
      World.nextRun() ;
      //console.log( matrix ) ;
      World.drawWorld();
      break;
  }
}

document.addEventListener("keydown", keydownEvent );


// ==== 全域變數 ===============================
const canvas = document.getElementById('_Canvas');
const ctx = canvas.getContext('2d');
const CELL_SIZE = 14;
const WINDOW_ROWS = 50;
const WINDOW_COLS = 50;
const WORLD_ROWS = 50;
const WORLD_COLS = 50;

//初始化matrix陣列，每個陣列可能是鹿或樹
let matrix = [] ; 
for( let row=0; row<WORLD_ROWS; row++ ) {
  matrix[row] = [];
  for( let col=0; col<WORLD_COLS; col++ ) {
    matrix[row][col] = 0 ;
  }
}
matrix[5][5] = new Tree() ;
matrix[5][45] = new Tree() ;
matrix[45][5] = new Tree() ;
matrix[45][45] = new Tree() ;
matrix[25][25] = new Tree() ;
console.log( "haveTreeAround(4,4):" + haveTreeAound(4,4) );
console.log( "haveTreeAround(6,6):" + haveTreeAound(6,6) );
console.log( matrix[4][3].limitHeight ) ;

console.log( matrix ) ;
// ====== Example  ======
let andyHeigh =0;
let name = "Andy Lin";
for ( let i=0; i<10; i++ ) {
}

function coord( row, col) {
  return row*10+col;
}

let ret = coord( 3, 4) ;
console.log( "ret=" + ret ) ;

let abc = [] ;
abc[0] = 0;
abc[1] = 2;
console.log(abc) ;

class Frog {
  color = "red" ;
  jump(step) {
    console.log( "jump="+ step ) ;
  }
}

let frog1 = new Frog() ;
console.log( frog1.color ) ;
frog1.color = "black" ;
console.log( frog1.color ) ;
frog1.jump(5) ;

let frog2 = new Frog() ;
console.log( frog2 ) ;


// =============================================
 
</script>